<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Distribuidora La Victoria</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #28a745;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, #20c997 100%);
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 10px;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            color: white;
            transform: translateX(5px);
        }
        
        .sidebar .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        
        .main-content {
            padding: 20px;
            margin-left: 0;
        }
        
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #20c997 100%);
            color: white;
            font-weight: 600;
            border: none;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-2px);
        }
        
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        
        .badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
        }
        
        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .alert {
            border-radius: 8px;
            border: none;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-btn {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h5><i class="fas fa-candy-cane me-2"></i>Admin Panel</h5>
                        <small id="adminUserName">Administrador</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="fas fa-tachometer-alt"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="products">
                                <i class="fas fa-box"></i>Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="inventory">
                                <i class="fas fa-warehouse"></i>Inventario
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="orders">
                                <i class="fas fa-shopping-cart"></i>Pedidos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="customers">
                                <i class="fas fa-users"></i>Clientes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="reports">
                                <i class="fas fa-chart-bar"></i>Reportes
                            </a>
                        </li>
                    </ul>
                    
                    <hr class="my-3">
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/" target="_blank">
                                <i class="fas fa-external-link-alt"></i>Ver Sitio Web
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i>Cerrar Sesi√≥n
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <!-- Mobile menu button -->
                <button class="btn btn-primary d-md-none mb-3" style="display: none;" id="toggleSidebar">
                    <i class="fas fa-bars"></i> Men√∫
                </button>

                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-tachometer-alt text-primary me-2"></i>Dashboard</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">Total Productos</h6>
                                        <div class="stats-number" id="totalProducts">0</div>
                                    </div>
                                    <i class="fas fa-box fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">Pedidos Hoy</h6>
                                        <div class="stats-number" id="ordersToday">0</div>
                                    </div>
                                    <i class="fas fa-shopping-cart fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">Ventas del Mes</h6>
                                        <div class="stats-number" id="monthSales">$0</div>
                                    </div>
                                    <i class="fas fa-dollar-sign fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">Productos Agotados</h6>
                                        <div class="stats-number" id="outOfStock">0</div>
                                    </div>
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Actividad Reciente</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActivity">
                                        <p class="text-muted">Cargando actividad reciente...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Alertas de Stock</h5>
                                </div>
                                <div class="card-body">
                                    <div id="stockAlerts">
                                        <p class="text-muted">Cargando alertas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="products" class="section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2"><i class="fas fa-box text-primary me-2"></i>Gesti√≥n de Productos</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-primary" id="addProductBtn">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchProducts" placeholder="Buscar productos...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="categoryFilter">
                                <option value="">Todas las categor√≠as</option>
                                <option value="chocolates">Chocolates</option>
                                <option value="dulceria">Dulcer√≠a</option>
                                <option value="galleteria">Galleter√≠a</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="stockFilter">
                                <option value="">Todos los stocks</option>
                                <option value="available">En stock</option>
                                <option value="low">Stock bajo</option>
                                <option value="out">Agotado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary me-2" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                            <button class="btn btn-outline-info btn-sm" id="debugBtn">
                                <i class="fas fa-bug"></i> Debug
                            </button>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Imagen</th>
                                            <th>Nombre</th>
                                            <th>Categor√≠a</th>
                                            <th>Descripci√≥n</th>
                                            <th>Precio</th>
                                            <th>Stock</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center">Cargando productos...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other sections placeholder -->
                <div id="inventory" class="section">
                    <h1 class="h2"><i class="fas fa-warehouse text-primary me-2"></i>Control de Inventario</h1>
                    <p>Pr√≥ximamente...</p>
                </div>

                <div id="orders" class="section">
                    <h1 class="h2"><i class="fas fa-shopping-cart text-primary me-2"></i>Gesti√≥n de Pedidos</h1>
                    <p>Pr√≥ximamente...</p>
                </div>

                <div id="customers" class="section">
                    <h1 class="h2"><i class="fas fa-users text-primary me-2"></i>Gesti√≥n de Clientes</h1>
                    <p>Pr√≥ximamente...</p>
                </div>

                <div id="reports" class="section">
                    <h1 class="h2"><i class="fas fa-chart-bar text-primary me-2"></i>Reportes</h1>
                    <p>Pr√≥ximamente...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">
                        <i class="fas fa-plus me-2"></i>Agregar Producto
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">Categor√≠a *</label>
                                    <select class="form-control" id="productCategory" required>
                                        <option value="">Seleccionar categor√≠a</option>
                                        <option value="chocolates">Chocolates</option>
                                        <option value="dulceria">Dulcer√≠a</option>
                                        <option value="galleteria">Galleter√≠a</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="productDescription" class="form-label">Descripci√≥n</label>
                                    <textarea class="form-control" id="productDescription" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="productPrice" class="form-label">Precio *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="productPrice" step="0.01" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productStock" class="form-label">Cantidad en Stock *</label>
                                    <input type="number" class="form-control" id="productStock" min="0" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="productImage" class="form-label">URL de la Imagen</label>
                                    <input type="url" class="form-control" id="productImage" placeholder="https://ejemplo.com/imagen.jpg">
                                    <small class="text-muted">Ingresa la URL de la imagen del producto</small>
                                </div>
                                
                                <div class="mb-3" id="imagePreview" style="display: none;">
                                    <img id="previewImg" class="image-preview" alt="Vista previa">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">
                        <i class="fas fa-save me-2"></i>Guardar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase Configuration -->
    <script>
        // CONFIGURACI√ìN DE SUPABASE - USA TUS CREDENCIALES REALES
        const SUPABASE_URL = 'https://jgjckpiodbswzkajxxsd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpnamNrcGlvZGJzd3prYWp4eHNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMzcxMTksImV4cCI6MjA2ODgxMzExOX0.bxs1YS_oE5s7Gvsss8w1jBLSiLnSxXywstzQHAQjS3U';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variables globales
        let currentProducts = [];
        let filteredProducts = [];
        let editingProduct = null;
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ === ADMIN DASHBOARD INICIADO ===');
            console.log('üìä Verificando dependencias...');
            console.log('- Supabase disponible:', !!window.supabase);
            console.log('- Bootstrap disponible:', !!window.bootstrap);
            
            try {
                setupEventListeners();
                await loadDashboardData();
                await loadProducts();
                
                console.log('‚úÖ Admin Dashboard completamente cargado');
                
            } catch (error) {
                console.error('‚ùå Error durante inicializaci√≥n:', error);
                showAlert('Error al inicializar el dashboard: ' + error.message, 'error');
            }
        });
        
        // Configurar event listeners
        function setupEventListeners() {
            console.log('üîó Configurando event listeners...');
            
            // Navegaci√≥n del sidebar
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                });
            });
            
            // Botones principales
            document.getElementById('addProductBtn').addEventListener('click', showAddProductModal);
            document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
            document.getElementById('refreshBtn').addEventListener('click', loadProducts);
            document.getElementById('debugBtn').addEventListener('click', debugInfo);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Filtros
            document.getElementById('searchProducts').addEventListener('keyup', filterProducts);
            document.getElementById('categoryFilter').addEventListener('change', filterProducts);
            document.getElementById('stockFilter').addEventListener('change', filterProducts);
            
            // Vista previa de imagen
            document.getElementById('productImage').addEventListener('input', function() {
                const url = this.value;
                const preview = document.getElementById('imagePreview');
                const img = document.getElementById('previewImg');
                
                if (url) {
                    preview.style.display = 'block';
                    img.src = url;
                    img.onerror = function() {
                        preview.style.display = 'none';
                    };
                } else {
                    preview.style.display = 'none';
                }
            });
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                showLoading(true);
                
                // Cargar estad√≠sticas b√°sicas
                document.getElementById('ordersToday').textContent = '12';
                document.getElementById('monthSales').textContent = '$2,450,000';
                
                generateRecentActivity();
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            } finally {
                showLoading(false);
            }
        }
        
        // Cargar productos
        async function loadProducts() {
            try {
                showLoading(true);
                console.log('üîç Cargando productos...');
                
                const { data: products, error } = await supabase
                    .from('productos')
                    .select('*')
                    .order('id', { ascending: false });
                
                if (error) throw error;
                
                currentProducts = products || [];
                filteredProducts = [...currentProducts];
                displayProducts(filteredProducts);
                
                // Actualizar estad√≠sticas
                document.getElementById('totalProducts').textContent = currentProducts.length;
                
                const outOfStock = currentProducts.filter(p => (p.stock || 0) <= 0).length;
                document.getElementById('outOfStock').textContent = outOfStock;
                
                const lowStock = currentProducts.filter(p => {
                    const stock = p.stock || 0;
                    return stock <= 5 && stock > 0;
                });
                generateStockAlerts(lowStock);
                
                console.log(`‚úÖ ${currentProducts.length} productos cargados exitosamente`);
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                showAlert('Error al cargar productos: ' + error.message, 'error');
                
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar productos. Verifica la conexi√≥n a la base de datos.</td></tr>';
            } finally {
                showLoading(false);
            }
        }
        
        // Mostrar productos en la tabla
        function displayProducts(products) {
            const tbody = document.getElementById('productsTableBody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay productos para mostrar</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td><strong>#${product.id}</strong></td>
                    <td>
                        ${product.imagen_url ? 
                            `<img src="${product.imagen_url}" class="product-image" alt="${product.nombre}" onerror="this.style.display='none'">` :
                            '<div class="product-image bg-light d-flex align-items-center justify-content-center"><i class="fas fa-image text-muted"></i></div>'
                        }
                    </td>
                    <td>
                        <strong>${product.nombre || 'Sin nombre'}</strong>
                    </td>
                    <td>
                        ${product.categoria ? `<span class="badge bg-primary">${getCategoryName(product.categoria)}</span>` : '<span class="badge bg-secondary">Sin categor√≠a</span>'}
                    </td>
                    <td>
                        <span class="text-muted">${product.descripcion || 'Sin descripci√≥n'}</span>
                    </td>
                    <td>
                        <strong class="text-success">$${parseFloat(product.precio || 0).toLocaleString()}</strong>
                    </td>
                    <td>
                        <span class="badge ${getStockBadgeClass(product.stock || 0)}">
                            ${product.stock || 0} UND
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Funciones auxiliares
        function getCategoryName(category) {
            const categories = {
                'chocolates': 'Chocolates',
                'dulceria': 'Dulcer√≠a',
                'galleteria': 'Galleter√≠a'
            };
            return categories[category] || category;
        }
        
        function getStockBadgeClass(stock) {
            if (stock <= 0) return 'bg-danger';
            if (stock <= 5) return 'bg-warning';
            return 'bg-success';
        }
        
        // Filtrar productos
        function filterProducts() {
            const search = document.getElementById('searchProducts').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const stock = document.getElementById('stockFilter').value;
            
            filteredProducts = currentProducts.filter(product => {
                let matches = true;
                
                // Filtro por b√∫squeda
                if (search) {
                    const nombre = product.nombre || '';
                    if (!nombre.toLowerCase().includes(search)) matches = false;
                }
                
                // Filtro por categor√≠a
                if (category) {
                    if (product.categoria !== category) matches = false;
                }
                
                // Filtro por stock
                if (stock) {
                    const stockValue = product.stock || 0;
                    switch(stock) {
                        case 'available':
                            if (stockValue <= 0) matches = false;
                            break;
                        case 'low':
                            if (stockValue > 5) matches = false;
                            break;
                        case 'out':
                            if (stockValue > 0) matches = false;
                            break;
                    }
                }
                
                return matches;
            });
            
            displayProducts(filteredProducts);
        }
        
        // Mostrar modal para agregar producto
        function showAddProductModal() {
            console.log('‚ûï === ABRIENDO MODAL AGREGAR ===');
            
            try {
                editingProduct = null;
                document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Agregar Producto';
                
                // Limpiar formulario
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                
                console.log('‚úÖ Formulario limpio, abriendo modal...');
                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
                
            } catch (error) {
                console.error('‚ùå Error abriendo modal:', error);
                showAlert('Error al abrir formulario de producto', 'error');
            }
        }
        
        // Editar producto
        function editProduct(productId) {
            console.log('üîß === INICIANDO EDICI√ìN ===');
            console.log('ID recibido:', productId, typeof productId);
            
            const product = currentProducts.find(p => p.id == productId);
            
            if (!product) {
                console.error('‚ùå Producto NO encontrado');
                showAlert('Producto no encontrado', 'error');
                return;
            }
            
            try {
                editingProduct = product;
                document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Producto';
                
                // Llenar formulario
                document.getElementById('productId').value = product.id || '';
                document.getElementById('productName').value = product.nombre || '';
                document.getElementById('productPrice').value = product.precio || '';
                document.getElementById('productStock').value = product.stock || '';
                document.getElementById('productCategory').value = product.categoria || '';
                document.getElementById('productDescription').value = product.descripcion || '';
                
                const imagenUrl = product.imagen_url || '';
                document.getElementById('productImage').value = imagenUrl;
                
                // Mostrar imagen
                if (imagenUrl) {
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('previewImg').src = imagenUrl;
                } else {
                    document.getElementById('imagePreview').style.display = 'none';
                }
                
                console.log('‚úÖ Formulario llenado, abriendo modal...');
                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
                
            } catch (error) {
                console.error('‚ùå Error llenando formulario:', error);
                showAlert('Error al abrir formulario de edici√≥n', 'error');
            }
        }
        
        // Guardar producto
        async function saveProduct() {
            console.log('üíæ === INICIANDO GUARDADO ===');
            
            try {
                showLoading(true);
                
                // Obtener datos del formulario
                const nombre = document.getElementById('productName').value.trim();
                const precio = parseFloat(document.getElementById('productPrice').value) || 0;
                const stock = parseInt(document.getElementById('productStock').value) || 0;
                const categoria = document.getElementById('productCategory').value;
                const descripcion = document.getElementById('productDescription').value.trim();
                const imagen_url = document.getElementById('productImage').value.trim();
                
                console.log('üìù Datos b√°sicos:', { nombre, precio, stock });
                
                // Validaciones b√°sicas
                if (!nombre) {
                    showAlert('El nombre del producto es requerido', 'error');
                    return;
                }
                
                if (precio <= 0) {
                    showAlert('El precio debe ser mayor a 0', 'error');
                    return;
                }
                
                // Construir objeto de datos
                const productData = {
                    nombre: nombre,
                    precio: precio,
                    stock: stock,
                    categoria: categoria,
                    descripcion: descripcion,
                    imagen_url: imagen_url
                };
                
                console.log('üíæ Datos finales a guardar:', productData);
                
                let result;
                if (editingProduct) {
                    // ACTUALIZAR producto existente
                    const productId = editingProduct.id;
                    console.log('üîÑ Actualizando producto ID:', productId);
                    
                    const { data, error } = await supabase
                        .from('productos')
                        .update(productData)
                        .eq('id', productId)
                        .select();
                    
                    if (error) {
                        console.error('‚ùå Error actualizando:', error);
                        throw error;
                    }
                    
                    result = data;
                    showAlert('Producto actualizado correctamente', 'success');
                    console.log('‚úÖ Producto actualizado:', result);
                    
                } else {
                    // CREAR nuevo producto
                    console.log('üìù Creando nuevo producto');
                    
                    const { data, error } = await supabase
                        .from('productos')
                        .insert([productData])
                        .select();
                    
                    if (error) {
                        console.error('‚ùå Error creando:', error);
                        throw error;
                    }
                    
                    result = data;
                    showAlert('Producto creado correctamente', 'success');
                    console.log('‚úÖ Producto creado:', result);
                }
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Recargar datos
                console.log('üîÑ Recargando lista de productos...');
                await loadProducts();
                
            } catch (error) {
                console.error('‚ùå Error completo guardando producto:', error);
                showAlert('Error al guardar producto: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // FUNCI√ìN DE DIAGN√ìSTICO COMPLETO DE PERMISOS
        async function diagnosticPermissions() {
            console.log('üîç === DIAGN√ìSTICO COMPLETO DE PERMISOS ===');
            
            try {
                // 1. Verificar usuario actual
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                console.log('üë§ Usuario actual:', user ? user.email : 'No autenticado');
                console.log('üë§ ID de usuario:', user ? user.id : 'N/A');
                
                if (!user) {
                    console.error('‚ùå Usuario no autenticado');
                    return { success: false, error: 'Usuario no autenticado' };
                }
                
                // 2. Probar SELECT
                console.log('üìñ Probando SELECT...');
                const { data: selectData, error: selectError } = await supabase
                    .from('productos')
                    .select('id, nombre')
                    .limit(1);
                    
                console.log('üìñ SELECT resultado:', { data: selectData, error: selectError });
                
                // 3. Probar INSERT (crear producto temporal)
                console.log('‚ûï Probando INSERT...');
                const testProduct = {
                    nombre: 'PRODUCTO_TEST_' + Date.now(),
                    precio: 1000,
                    stock: 1,
                    categoria: 'chocolates',
                    descripcion: 'Producto de prueba para diagn√≥stico'
                };
                
                const { data: insertData, error: insertError } = await supabase
                    .from('productos')
                    .insert([testProduct])
                    .select();
                    
                console.log('‚ûï INSERT resultado:', { data: insertData, error: insertError });
                
                let testProductId = null;
                if (insertData && insertData.length > 0) {
                    testProductId = insertData[0].id;
                }
                
                // 4. Probar UPDATE
                if (testProductId) {
                    console.log('üìù Probando UPDATE...');
                    const { data: updateData, error: updateError } = await supabase
                        .from('productos')
                        .update({ descripcion: 'Producto actualizado para prueba' })
                        .eq('id', testProductId)
                        .select();
                        
                    console.log('üìù UPDATE resultado:', { data: updateData, error: updateError });
                }
                
                // 5. Probar DELETE
                if (testProductId) {
                    console.log('üóëÔ∏è Probando DELETE...');
                    const { data: deleteData, error: deleteError, count } = await supabase
                        .from('productos')
                        .delete({ count: 'exact' })
                        .eq('id', testProductId)
                        .select();
                        
                    console.log('üóëÔ∏è DELETE resultado:', { data: deleteData, error: deleteError, count });
                    
                    // Verificar si realmente se elimin√≥
                    if (!deleteError) {
                        const { data: checkData, error: checkError } = await supabase
                            .from('productos')
                            .select('id')
                            .eq('id', testProductId);
                            
                        console.log('üîç Verificaci√≥n post-DELETE:', { data: checkData, error: checkError });
                    }
                }
                
                return { success: true };
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Eliminar producto - VERSI√ìN CON DIAGN√ìSTICO AUTOM√ÅTICO
        async function deleteProduct(productId) {
            console.log('üóëÔ∏è === INICIANDO ELIMINACI√ìN ===');
            console.log('ID recibido:', productId, typeof productId);
            
            const product = currentProducts.find(p => p.id == productId);
            
            if (!product) {
                console.error('‚ùå Producto NO encontrado');
                showAlert('Producto no encontrado', 'error');
                return;
            }
            
            const productName = product.nombre || 'Producto sin nombre';
            console.log('üìã Producto a eliminar:', productName);
            
            // Confirmaci√≥n
            if (!confirm(`¬øEliminar "${productName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                // Verificar usuario
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('Usuario no autenticado. Inicia sesi√≥n para eliminar productos.');
                }
                
                console.log('üë§ Usuario autenticado:', user.email);
                
                // M√©todo directo con informaci√≥n detallada
                console.log('üîÑ Intentando eliminaci√≥n directa...');
                const { data, error, count } = await supabase
                    .from('productos')
                    .delete({ count: 'exact' })
                    .eq('id', productId);
                
                console.log('üìä Resultado completo de eliminaci√≥n:', {
                    data,
                    error,
                    count,
                    productId,
                    productName
                });
                
                if (error) {
                    console.error('‚ùå Error detallado:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // Mostrar mensaje espec√≠fico seg√∫n el error
                    let userMessage = '';
                    switch(error.code) {
                        case '42501':
                            userMessage = 'Sin permisos para eliminar productos. Configura las pol√≠ticas RLS en Supabase.';
                            break;
                        case '23503':
                            userMessage = 'No se puede eliminar: el producto est√° siendo usado en otras tablas.';
                            break;
                        case 'PGRST301':
                            userMessage = 'Sin permisos para eliminar. Verifica la configuraci√≥n de autenticaci√≥n.';
                            break;
                        default:
                            userMessage = `Error: ${error.message}`;
                    }
                    
                    showAlert(userMessage, 'error');
                    
                    // Mostrar gu√≠a de soluci√≥n
                    setTimeout(() => {
                        showPermissionGuide(error.code);
                    }, 2000);
                    
                    return;
                }
                
                // Verificar si se elimin√≥
                if (count === 0) {
                    console.warn('‚ö†Ô∏è No se elimin√≥ ninguna fila');
                    showAlert('No se pudo eliminar el producto. Puede que ya no exista.', 'warning');
                    await loadProducts(); // Recargar para verificar estado actual
                    return;
                }
                
                console.log(`‚úÖ Eliminaci√≥n exitosa: ${count} producto(s) eliminado(s)`);
                
                // Actualizar UI inmediatamente
                currentProducts = currentProducts.filter(p => p.id != productId);
                filteredProducts = filteredProducts.filter(p => p.id != productId);
                displayProducts(filteredProducts);
                
                // Actualizar estad√≠sticas
                document.getElementById('totalProducts').textContent = currentProducts.length;
                const outOfStock = currentProducts.filter(p => (p.stock || 0) <= 0).length;
                document.getElementById('outOfStock').textContent = outOfStock;
                
                showAlert(`Producto "${productName}" eliminado correctamente`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                showAlert(`Error al eliminar: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Funci√≥n para mostrar gu√≠a de permisos
        function showPermissionGuide(errorCode) {
            let guide = '';
            
            switch(errorCode) {
                case '42501':
                case 'PGRST301':
                    guide = `
üîß SOLUCI√ìN PARA PERMISOS:
1. Ve a tu proyecto en Supabase
2. Authentication ‚Üí Policies  
3. Busca la tabla 'productos'
4. Crea una pol√≠tica DELETE:
   - Nombre: "Allow DELETE for authenticated users"
   - Policy: DELETE
   - Target roles: authenticated
   - Using expression: true
   - With check: true

O TEMPORALMENTE:
- Table Editor ‚Üí productos ‚Üí Settings
- Desactiva "Enable Row Level Security"
                    `;
                    break;
                default:
                    guide = 'Verifica la configuraci√≥n de permisos en Supabase';
            }
            
            console.log(guide);
            
            if (confirm('¬øQuieres que te ayude a configurar los permisos? (Ver consola para instrucciones)')) {
                window.open('https://supabase.com/dashboard', '_blank');
            }
        }
        
        // Funciones de navegaci√≥n
        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionName).classList.add('active');
            
            // Actualizar navegaci√≥n activa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
            
            // Cargar datos espec√≠ficos de la secci√≥n si es necesario
            if (sectionName === 'dashboard') {
                loadDashboardData();
            } else if (sectionName === 'products') {
                loadProducts();
            }
        }
        
        // Generar alertas de stock
        function generateStockAlerts(lowStockProducts) {
            const container = document.getElementById('stockAlerts');
            
            if (lowStockProducts.length === 0) {
                container.innerHTML = '<p class="text-success"><i class="fas fa-check-circle me-2"></i>Todos los productos tienen stock adecuado</p>';
                return;
            }
            
            container.innerHTML = lowStockProducts.map(product => {
                const nombre = product.nombre || 'Producto sin nombre';
                const stock = product.stock || 0;
                
                return `
                    <div class="alert alert-warning alert-sm d-flex align-items-center mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <strong>${nombre}</strong><br>
                            <small>Stock: ${stock} unidades</small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Generar actividad reciente
        function generateRecentActivity() {
            const activities = [
                { icon: 'plus', text: 'Nuevo producto agregado: "Chocolate Premium"', time: '10 min ago', color: 'success' },
                { icon: 'edit', text: 'Producto actualizado: "Gomitas Surtidas"', time: '25 min ago', color: 'info' },
                { icon: 'shopping-cart', text: 'Nueva orden #1234 recibida', time: '1 hora ago', color: 'primary' },
                { icon: 'exclamation-triangle', text: 'Stock bajo: "Caramelos de Caf√©"', time: '2 horas ago', color: 'warning' }
            ];
            
            document.getElementById('recentActivity').innerHTML = activities.map(activity => `
                <div class="d-flex align-items-center mb-3">
                    <div class="rounded-circle bg-${activity.color} text-white d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                        <i class="fas fa-${activity.icon} fa-sm"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="text-sm">${activity.text}</div>
                        <div class="text-muted small">${activity.time}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Funciones utilitarias
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('show');
        }
        
        // Funci√≥n de debug mejorada
        function debugInfo() {
            console.log('üêõ === INFORMACI√ìN DE DEBUG ===');
            console.log('üìä Total productos cargados:', currentProducts.length);
            console.log('üìã Primer producto (muestra):', currentProducts[0]);
            console.log('üîó Cliente Supabase:', !!supabase);
            console.log('üåê URL Supabase:', SUPABASE_URL);
            
            const info = `
DEBUG INFO:
- Productos cargados: ${currentProducts.length}
- Supabase conectado: ${!!supabase ? 'S√≠' : 'No'}
- URL: ${SUPABASE_URL}

¬øQuieres probar todos los permisos de la base de datos?
            `;
            
            if (confirm(info + '\n\nEsto crear√° un producto de prueba para verificar permisos.')) {
                diagnosticPermissions();
            }
        }
        
        // Logout  
        async function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    window.location.href = '/';
                } catch (error) {
                    console.error('Error cerrando sesi√≥n:', error);
                    showAlert('Error al cerrar sesi√≥n', 'error');
                }
            }
        }
        
        // Hacer funciones disponibles globalmente
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.diagnosticPermissions = diagnosticPermissions;
    </script>
</body>
</html>
